<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Agent Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#faf5ff', 100: '#f3e8ff', 500: '#a855f7', 600: '#9333ea', 700: '#7c3aed' },
                        surface: { 50: '#f8fafc', 100: '#f1f5f9', 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .card-light {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.4);
        }

        .order-row:hover {
            background: rgba(168, 85, 247, 0.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .confidence-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
    </style>
</head>

<body class="bg-surface-900 min-h-screen text-slate-200">
    <!-- Header -->
    <header class="sticky top-0 z-50 border-b border-slate-800 bg-surface-900/80 backdrop-blur-lg">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-lg shadow-purple-500/20">
                        <i data-lucide="package" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-white">Inventory Agent</h1>
                        <p class="text-xs text-slate-400">AI-Powered Restocking System</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div
                        class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                        <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                        <span class="text-xs font-medium text-emerald-400">Online</span>
                    </div>
                    <button onclick="refreshData()"
                        class="p-2 rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card rounded-2xl p-5 animate-fade-in">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-purple-400 uppercase tracking-wide">Total Orders</span>
                    <i data-lucide="package" class="w-4 h-4 text-purple-400"></i>
                </div>
                <p id="stat-total" class="text-3xl font-bold text-white">0</p>
                <p class="text-xs text-slate-500 mt-1">Purchase orders created</p>
            </div>

            <div class="card-light rounded-2xl p-5 animate-fade-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-emerald-400 uppercase tracking-wide">Completed</span>
                    <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <p id="stat-executed" class="text-3xl font-bold text-white">0</p>
                <p class="text-xs text-slate-500 mt-1">Auto-approved by AI</p>
            </div>

            <div class="card-light rounded-2xl p-5 animate-fade-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-amber-400 uppercase tracking-wide">Pending</span>
                    <i data-lucide="clock" class="w-4 h-4 text-amber-400"></i>
                </div>
                <p id="stat-pending" class="text-3xl font-bold text-white">0</p>
                <p class="text-xs text-slate-500 mt-1">Awaiting your review</p>
            </div>

            <div class="card-light rounded-2xl p-5 animate-fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-cyan-400 uppercase tracking-wide">AI Score</span>
                    <i data-lucide="brain" class="w-4 h-4 text-cyan-400"></i>
                </div>
                <p id="stat-confidence" class="text-3xl font-bold text-white">0%</p>
                <p class="text-xs text-slate-500 mt-1">Average confidence</p>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Orders Table -->
            <div class="lg:col-span-2 card rounded-2xl overflow-hidden animate-fade-in">
                <div class="px-6 py-4 border-b border-slate-700/50 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="clipboard-list" class="w-4 h-4 text-purple-400"></i>
                        <h2 class="font-semibold text-white">Recent Orders</h2>
                    </div>
                    <span class="text-xs text-slate-500">Last 10</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr
                                class="text-left text-xs text-slate-500 uppercase tracking-wide border-b border-slate-800">
                                <th class="px-6 py-3 font-medium">Material</th>
                                <th class="px-6 py-3 font-medium">Quantity</th>
                                <th class="px-6 py-3 font-medium">Confidence</th>
                                <th class="px-6 py-3 font-medium">Status</th>
                                <th class="px-6 py-3 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table" class="divide-y divide-slate-800/50">
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                                    <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin opacity-50"></i>
                                    <p>Loading orders...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Action -->
                <div class="card rounded-2xl p-6 animate-fade-in">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="zap" class="w-4 h-4 text-amber-400"></i>
                        <h3 class="font-semibold text-white">Check Inventory</h3>
                    </div>
                    <div class="space-y-3">
                        <select id="product-select"
                            class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500/20">
                            <option value="STEEL_SHEETS">Steel Sheets</option>
                            <option value="ALUMINUM_BARS">Aluminum Bars</option>
                            <option value="COPPER_WIRE">Copper Wire</option>
                            <option value="PLASTIC_PELLETS">Plastic Pellets</option>
                            <option value="TITANIUM_RODS">Titanium Rods</option>
                            <option value="RUBBER_SHEETS">Rubber Sheets</option>
                        </select>
                        <button onclick="triggerOrder()" id="trigger-btn"
                            class="w-full btn-primary py-3 rounded-xl font-medium text-white flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i>
                            Run Analysis
                        </button>
                        <button onclick="showVerification()"
                            class="w-full py-2.5 rounded-xl border border-slate-700 text-slate-400 text-sm hover:bg-slate-800 hover:text-white transition flex items-center justify-center gap-2">
                            <i data-lucide="calculator" class="w-3.5 h-3.5"></i>
                            View Calculations
                        </button>
                    </div>
                </div>

                <!-- Products Chart -->
                <div class="card rounded-2xl p-6 animate-fade-in">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="pie-chart" class="w-4 h-4 text-cyan-400"></i>
                        <h3 class="font-semibold text-white">Orders by Product</h3>
                    </div>
                    <div class="h-44">
                        <canvas id="productChart"></canvas>
                    </div>
                </div>

                <!-- Telegram -->
                <div class="card rounded-2xl p-6 animate-fade-in">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="bell" class="w-4 h-4 text-blue-400"></i>
                        <h3 class="font-semibold text-white">Telegram Alerts</h3>
                    </div>
                    <div class="text-center">
                        <div class="w-28 h-28 mx-auto mb-3 bg-white rounded-xl p-1.5 shadow-lg">
                            <img id="telegram-qr" src="" alt="QR Code" class="w-full h-full rounded-lg">
                        </div>
                        <p class="text-xs text-slate-400 mb-2">Scan to receive alerts</p>
                        <a id="telegram-link" href="#" target="_blank"
                            class="text-xs text-blue-400 hover:underline">Open in Telegram →</a>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card rounded-2xl p-6 animate-fade-in">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="activity" class="w-4 h-4 text-emerald-400"></i>
                        <h3 class="font-semibold text-white">System Status</h3>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">API</span>
                            <span id="health-api"
                                class="px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400 text-xs font-medium">Healthy</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">AI Model</span>
                            <span class="text-slate-300 text-xs">Gemini 2.0 Flash</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Database</span>
                            <span class="text-slate-300 text-xs">SQLite Connected</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Latency</span>
                            <span class="text-slate-300 text-xs">~3s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Verification Modal -->
    <div id="verification-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeVerification()"></div>
        <div class="absolute inset-4 md:inset-10 lg:inset-20 flex items-center justify-center">
            <div class="card rounded-2xl w-full max-w-2xl max-h-full overflow-auto p-6 relative">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <i data-lucide="calculator" class="w-5 h-5 text-purple-400"></i>
                        <h2 class="text-lg font-semibold text-white">Calculation Breakdown</h2>
                    </div>
                    <button onclick="closeVerification()"
                        class="p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="verification-content">
                    <div class="text-center py-12 text-slate-500">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-3 animate-spin opacity-50"></i>
                        <p>Loading calculations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-6 right-6 px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message" class="text-sm text-white"></p>
    </div>

    <script>
        lucide.createIcons();
        const API_KEY = 'dev-inventory-agent-2026';
        let productChart = null;

        async function fetchWithAuth(url, options = {}) {
            const headers = { 'X-API-Key': API_KEY, 'Content-Type': 'application/json', ...options.headers };
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            msgEl.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            if (type === 'error') toast.style.borderColor = '#ef4444';
            else if (type === 'success') toast.style.borderColor = '#10b981';
            else toast.style.borderColor = '#a855f7';
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function getConfidenceColor(conf) {
            if (conf >= 0.8) return '#10b981';
            if (conf >= 0.6) return '#f59e0b';
            return '#ef4444';
        }

        function renderOrderRow(order) {
            const conf = order.confidence || 0;
            const confPct = Math.round(conf * 100);
            const isExecuted = order.status === 'executed';
            const productName = (order.product_id || '').replace(/_/g, ' ');

            return `
                <tr class="order-row transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center">
                                <i data-lucide="cube" class="w-4 h-4 text-purple-400"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-white">${productName}</p>
                                <p class="text-xs text-slate-500">${(order.order_id || '').slice(-12)}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-white font-medium">${(order.quantity || 0).toLocaleString()}</span>
                        <span class="text-slate-500 text-sm"> units</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-16 confidence-bar">
                                <div class="confidence-fill" style="width: ${confPct}%; background: ${getConfidenceColor(conf)};"></div>
                            </div>
                            <span class="text-xs text-slate-400">${confPct}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 rounded-full text-xs font-medium ${isExecuted ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}">
                            ${isExecuted ? 'Completed' : 'Pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${!isExecuted ? `
                            <div class="flex gap-2">
                                <button onclick="approveOrder('${order.order_id}')" class="px-3 py-1.5 rounded-lg bg-emerald-500/10 text-emerald-400 text-xs font-medium hover:bg-emerald-500/20 transition">Approve</button>
                                <button onclick="rejectOrder('${order.order_id}')" class="px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 text-xs font-medium hover:bg-red-500/20 transition">Reject</button>
                            </div>
                        ` : '<span class="text-slate-600 text-xs">—</span>'}
                    </td>
                </tr>
            `;
        }

        async function refreshData() {
            try {
                const health = await fetch('/').then(r => r.json());
                document.getElementById('health-api').textContent = health.status === 'running' ? 'Healthy' : 'Error';

                const stats = await fetchWithAuth('/dashboard/stats');
                document.getElementById('stat-total').textContent = stats.total_orders || 0;
                document.getElementById('stat-executed').textContent = stats.status_breakdown?.executed || 0;
                document.getElementById('stat-pending').textContent = stats.status_breakdown?.pending_review || stats.status_breakdown?.pending || 0;
                document.getElementById('stat-confidence').textContent = `${Math.round((stats.average_confidence || 0) * 100)}%`;

                const tbody = document.getElementById('orders-table');
                if (stats.recent_orders?.length > 0) {
                    tbody.innerHTML = stats.recent_orders.map(renderOrderRow).join('');
                } else {
                    tbody.innerHTML = `
                        <tr><td colspan="5" class="px-6 py-12 text-center">
                            <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-slate-800 flex items-center justify-center">
                                <i data-lucide="inbox" class="w-6 h-6 text-slate-600"></i>
                            </div>
                            <p class="text-slate-500 mb-1">No orders yet</p>
                            <p class="text-xs text-slate-600">Run an analysis to create your first order</p>
                        </td></tr>
                    `;
                }
                updateChart(stats.top_products || []);
                lucide.createIcons();
            } catch (e) { console.error('Refresh failed:', e); }
        }

        function updateChart(products) {
            const ctx = document.getElementById('productChart').getContext('2d');
            if (productChart) productChart.destroy();
            if (products.length === 0) return;

            productChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: products.map(p => (p.product_id || '').replace(/_/g, ' ')),
                    datasets: [{ data: products.map(p => p.total_orders), backgroundColor: ['#a855f7', '#ec4899', '#22d3ee', '#10b981', '#f59e0b'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 12 } } } }
            });
        }

        async function loadTelegramSetup() {
            try {
                const data = await fetch('/telegram/setup').then(r => r.json());
                document.getElementById('telegram-qr').src = data.qr_url;
                document.getElementById('telegram-link').href = data.bot_link;
            } catch (e) { console.log('Telegram setup unavailable'); }
        }

        async function triggerOrder() {
            const btn = document.getElementById('trigger-btn');
            const product = document.getElementById('product-select').value;
            const name = document.getElementById('product-select').selectedOptions[0].text;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Analyzing...';
            showToast(`Analyzing ${name}...`, 'info');
            try {
                const result = await fetchWithAuth('/inventory-trigger', { method: 'POST', body: JSON.stringify({ product_id: product, mode: 'mock' }) });
                showToast(`✓ Order created: ${result.recommended_quantity || result.quantity} units`, 'success');
                refreshData();
            } catch (e) { showToast('Failed to create order', 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> Run Analysis'; lucide.createIcons(); }
        }

        async function showVerification() {
            const modal = document.getElementById('verification-modal');
            const content = document.getElementById('verification-content');
            const product = document.getElementById('product-select').value;
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="text-center py-12 text-slate-500"><i data-lucide="loader" class="w-8 h-8 mx-auto mb-3 animate-spin opacity-50"></i><p>Loading...</p></div>';
            lucide.createIcons();
            try {
                const data = await fetchWithAuth(`/verify-calculation/${product}`);
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 rounded-xl p-4">
                            <p class="text-xs text-purple-400 font-medium uppercase tracking-wide mb-3">Input Data</p>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div><span class="text-slate-500">Product:</span> <span class="text-white">${data.product_id}</span></div>
                                <div><span class="text-slate-500">Stock:</span> <span class="text-white">${data.inputs.current_stock}</span></div>
                                <div><span class="text-slate-500">Lead Time:</span> <span class="text-white">${data.inputs.lead_time_days} days</span></div>
                                <div><span class="text-slate-500">Service Level:</span> <span class="text-white">${data.inputs.service_level * 100}%</span></div>
                            </div>
                            <p class="text-xs text-slate-500 mt-3">Demand: [${data.inputs.demand_history.join(', ')}]</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-4">
                            <p class="text-xs text-emerald-400 font-medium uppercase tracking-wide mb-3">Calculations</p>
                            <div class="space-y-3 text-sm font-mono">
                                ${Object.entries(data.step_by_step).map(([k, v]) => `
                                    <div class="p-3 bg-slate-900/50 rounded-lg">
                                        <p class="text-slate-500 text-xs mb-1">${k.replace(/_/g, ' ').toUpperCase()}</p>
                                        <p class="text-purple-300">${v.formula}</p>
                                        ${v.calculation ? `<p class="text-slate-400 text-xs">= ${v.calculation}</p>` : ''}
                                        <p class="text-white font-bold mt-1">${v.result} ${v.unit || ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="rounded-xl p-4 ${data.decision.needs_restock ? 'bg-red-500/10 border border-red-500/20' : 'bg-emerald-500/10 border border-emerald-500/20'}">
                            <p class="font-semibold ${data.decision.needs_restock ? 'text-red-400' : 'text-emerald-400'} mb-2">${data.decision.needs_restock ? '⚠️ Restock Required' : '✅ Stock Sufficient'}</p>
                            <p class="text-sm text-slate-300">${data.decision.reason}</p>
                            ${data.decision.needs_restock ? `<p class="text-sm mt-2"><span class="text-slate-500">Order:</span> <span class="text-white font-bold">${data.decision.order_quantity} units</span> • <span class="text-slate-500">Cost:</span> <span class="text-white font-bold">$${data.decision.estimated_cost.toLocaleString()}</span></p>` : ''}
                        </div>
                    </div>
                `;
            } catch (e) { content.innerHTML = '<p class="text-red-400 text-center py-8">Failed to load verification data. Please restart the server.</p>'; }
            lucide.createIcons();
        }

        function closeVerification() { document.getElementById('verification-modal').classList.add('hidden'); }
        async function approveOrder(id) { try { await fetchWithAuth(`/orders/${id}/approve`, { method: 'POST' }); showToast('Order approved', 'success'); refreshData(); } catch (e) { showToast('Failed', 'error'); } }
        async function rejectOrder(id) { try { await fetchWithAuth(`/orders/${id}/reject`, { method: 'POST' }); showToast('Order rejected', 'info'); refreshData(); } catch (e) { showToast('Failed', 'error'); } }

        refreshData();
        loadTelegramSetup();
        setInterval(refreshData, 30000);
    </script>
</body>

</html>